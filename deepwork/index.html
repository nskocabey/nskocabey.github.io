<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tilt Timer</title>
    <style>
        body {
            margin: 0;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            background-color: #000;
            color: #fff;
            overflow: hidden;
            user-select: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
        }
        
        #display {
            position: relative;
            top: -15vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
            font-size: 40px;
            font-weight: 700;
            transition: opacity 0.1s;
        }
        
        #tiltValue {
            margin-right: 10px;
        }
        
        #separator {
            margin: 0 10px;
        }
        
        #timer {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="display">
        <span id="tiltValue">0</span>
        <span id="separator">|</span>
        <span id="timer">00:00</span>
    </div>

    <script>
        const display = {
            tilt: document.getElementById('tiltValue'),
            timer: document.getElementById('timer'),
            element: document.getElementById('display'),
            visible: true,
            toggle() {
                this.visible = !this.visible;
                this.element.style.opacity = this.visible ? '1' : '0';
            }
        };
        
        const timer = {
            active: false,
            start: null,
            interval: null,
            checkTimeout: null,
            
            start() {
                this.active = true;
                this.start = Date.now();
                this.interval = setInterval(() => this.update(), 1000);
            },
            
            stop() {
                if (this.active && this.start) {
                    // Calculate the duration of deep work
                    const duration = Math.floor((Date.now() - this.start) / 1000);
                    
                    // Only log if the session was at least 10 seconds
                    if (duration >= 10) {
                        this.logToGoogleSheets(duration);
                    }
                }
                
                this.active = false;
                clearInterval(this.interval);
                this.interval = null;
                display.timer.textContent = '00:00';
                this.start = null;
            },
            
            logToGoogleSheets(durationSeconds) {
                // Format the current date and time
                const now = new Date();
                const timestamp = now.toISOString();
                
                // Format the duration as MM:SS
                const minutes = Math.floor(durationSeconds / 60);
                const seconds = durationSeconds % 60;
                const durationFormatted = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Prepare the data to send
                const data = {
                    timestamp: timestamp,
                    duration: durationSeconds,
                    durationFormatted: durationFormatted
                };
                
                // Send data to web app URL
                const URL = 'https://script.google.com/macros/s/AKfycbyn9O5HPqnApYNKg4xpdDSnn_WoAcvt36Zo9wtYw8_OQ7bXmwzKvi8IPDoOVangdAMe/exec';
                
                fetch(URL, {
                    method: 'POST',
                    mode: 'no-cors', // This is important for cross-domain requests
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                }).catch(err => console.error('Error logging deep work session:', err));
            },
            
            update() {
                if (!this.active || !this.start) return;
                
                const elapsed = Math.floor((Date.now() - this.start) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                display.timer.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        };
        
        function initTiltTracking() {
            // Debounced tilt handler
            window.addEventListener('deviceorientation', e => {
                if (!e.beta) return;
                
                const tilt = Math.round(e.beta);
                const angle = tilt < 0 ? tilt : (tilt > 90 ? 90 : tilt);
                display.tilt.textContent = angle;
                
                // Use the improved tilt checking
                timer.checkTilt(angle);
            });
        }
        
        function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(result => {
                        if (result === 'granted') {
                            initTiltTracking();
                        }
                    })
                    .catch(console.error);
            } else {
                initTiltTracking();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            let permissionRequested = false;
            
            document.body.addEventListener('click', e => {
                if (!permissionRequested) {
                    requestOrientationPermission();
                    permissionRequested = true;
                    return;
                }
                
                display.toggle();
                e.preventDefault();
            });
        });
    </script>
</body>
</html>